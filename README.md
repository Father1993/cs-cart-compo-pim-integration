# PIM Sync - Интеграция Compo PIM с CS-Cart

## Описание

Аддон для автоматической синхронизации каталога товаров из системы Compo PIM в CS-Cart.

## Возможности

-   ✅ Полная синхронизация категорий и товаров
-   ✅ Инкрементальная синхронизация измененных товаров
-   ✅ Автоматическая загрузка изображений
-   ✅ Синхронизация характеристик товаров
-   ✅ Синхронизация производителей как характеристик
-   ✅ Конвертация единиц измерения (вес в граммы, размеры в см)
-   ✅ Валидация данных перед импортом
-   ✅ Журналирование всех операций
-   ✅ Интерфейс управления в админ-панели
-   ✅ Автоматическая синхронизация по расписанию (cron)

## Установка

### 1. Установка через админ-панель

1. Перейдите в админ-панель CS-Cart
2. Откройте раздел **Модули → Управление модулями**
3. Нажмите **+** для загрузки нового модуля
4. Загрузите архив с аддоном или укажите путь к папке `app/addons/pim_sync`
5. Найдите модуль "Compo PIM Synchronization" в списке
6. Нажмите **Установить**

### 2. Активация и настройка

1. После установки перейдите в настройки модуля
2. Укажите параметры подключения к API:
    - **URL API**: `your_api_url`
    - **Логин API**: ваш логин
    - **Пароль API**: ваш пароль
    - **UID каталога**: `1111-222-333-4444-55555555555`
3. Включите автоматическую синхронизацию если нужно
4. Сохраните настройки

### 3. Первый запуск

1. Перейдите в **Каталог → PIM синхронизация**
2. Нажмите **Проверить подключение** для проверки API
3. Выполните **Полную синхронизацию** для первичной загрузки данных

## Использование

### Ручная синхронизация

В админ-панели доступны следующие действия:

-   **Полная синхронизация** - загружает все категории и товары
-   **Синхронизировать изменения** - обновляет только измененные товары за указанный период
-   **Проверить подключение** - тестирует доступность API

### Автоматическая синхронизация

Для настройки автоматической синхронизации добавьте в crontab:

```bash
# Инкрементальная синхронизация каждые 30 минут
0,30 * * * * php /path/to/cscart/app/addons/pim_sync/cron/sync.php

# Полная синхронизация раз в неделю (воскресенье в 3:00)
0 3 * * 0 php /path/to/cscart/app/addons/pim_sync/cron/sync.php --full
```

Параметры cron-скрипта:

-   `--full` - выполнить полную синхронизацию
-   `--days=N` - синхронизировать товары за N дней (по умолчанию 1)

### Тестирование API

Для проверки работы API используйте тестовый скрипт:

```bash
# Скопируйте в корень CS-Cart
cp test_pim_connection.php /path/to/cscart/

# Откройте в браузере
http://your-domain.com/test_pim_connection.php
```

## Мониторинг

### Журнал синхронизации

Все операции записываются в:

-   База данных: таблица `cscart_pim_sync_log`
-   Файл: `var/pim_sync.log`

### Статистика

В интерфейсе управления отображается:

-   Количество синхронизированных категорий и товаров
-   Количество ошибок
-   Время последней синхронизации
-   Статус текущей операции

## Решение проблем

### Ошибка авторизации

1. Проверьте правильность логина и пароля
2. Убедитесь, что API доступен: your_api_url
3. Проверьте настройки firewall

### Таймаут при синхронизации

1. Увеличьте лимиты PHP:
    ```
    max_execution_time = 0
    memory_limit = 512M
    ```
2. Используйте cron для больших объемов данных

### Изображения не загружаются

1. Проверьте права на запись в папку `images/`
2. Убедитесь, что URL изображений доступны
3. Проверьте свободное место на диске

## Структура данных

### Маппинг полей

См. документацию: `/docs/integration/data-mapping.md`

### Таблицы БД

-   `cscart_pim_sync_state` - состояние синхронизации сущностей
-   `cscart_pim_sync_log` - журнал операций

## Известные особенности

### Маппинг данных

-   Вес товаров конвертируется из килограммов (PIM) в граммы (CS-Cart)
-   Размеры конвертируются из миллиметров (PIM) в сантиметры (CS-Cart)
-   Производители создаются как характеристики типа "Бренд"
-   Описания товаров объединяются: fullHeader + content

### Обработка статусов

-   `productStatus = 'ACTIVE'` → статус товара "Активен"
-   `productStatus = 'INACTIVE' или 'ARCHIVE'` → статус товара "Отключен"
-   Если `productStatus` отсутствует, используется поле `enabled`

## Поддержка

При возникновении проблем:

1. Проверьте логи в `var/pim_sync.log`
2. Изучите документацию в `/docs/integration/`
3. Обратитесь к администратору системы

### Автор

Andrej Spinej
